pipeline {
  agent any

  environment {
    AWS_SECRET_ACCESS_KEY = credentials('aws-secret-access-key')
    AWS_ACCESS_KEY_ID     = credentials('aws-access-key-id')
    AWS_REGION           = 'us-east-2'
    AWS_SSH_KEY          = credentials('AWS_SSH_KEY')
  }

  parameters {
    string(name: 'GIT_BRANCH', defaultValue: 'main', description: 'Git branch')
    booleanParam(name: 'DEPLOY_FRONTEND', defaultValue: true, description: 'Deploy frontend')
    string(name: 'DOMAIN_NAME', defaultValue: 'enny4life.duckdns.org', description: 'Domain')
    string(name: 'API_PORT', defaultValue: '8000', description: 'API port')
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Get IPs') {
      steps {
        dir('terraform') {
          script {
            env.BACKEND_IP = sh(script: "terraform output -json backend_private_ips | jq -r '.[0]'", returnStdout: true).trim()
            env.WEB_IPS = sh(script: "terraform output -json web_server_ips", returnStdout: true).trim()
          }
        }
      }
    }

    stage('Deploy') {
      when { expression { params.DEPLOY_FRONTEND } }
      steps {
        script {
          sshagent(['AWS_SSH_KEY']) {
            sh """
            for ip in \$(echo '${env.WEB_IPS}' | jq -r '.[]'); do
              ssh -o StrictHostKeyChecking=no ec2-user@\${ip} << EOF
                sudo rm -rf /tmp/fruits
                git clone -b ${params.GIT_BRANCH} https://github.com/ajanakueniola-commits/fruits-veg_market.git /tmp/fruits
                cd /tmp/fruits/frontend
                sed -i 's|http://localhost|http://${env.BACKEND_IP}:${params.API_PORT}|g' index.html
                sudo rm -rf /usr/share/nginx/html/*
                sudo cp index.html /usr/share/nginx/html/
                sudo nginx -t
                sudo systemctl restart nginx
EOF
            done
            """
          }
        }
      }
    }
  }
}
